name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  # CI 环境使用空凭据，仅编译检查
  CF_API_TOKEN: ""
  CF_ACCOUNT_ID: ""

jobs:
  # ── 安全扫描：确认无硬编码凭据 ──────────────────────
  secret-scan:
    name: Secret Leak Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for hardcoded credentials
        run: |
          echo "Scanning for potential hardcoded tokens..."
          # 排除 .env.example（里面是占位符）和此工作流文件本身
          FOUND=$(grep -rn --include='*.rs' --include='*.ts' --include='*.tsx' --include='*.json' \
            -E '(n0_FGk|64c5521f|api_token\s*=\s*"[a-zA-Z0-9_-]{20,}")' \
            --exclude-dir=target --exclude-dir=node_modules --exclude-dir=.git \
            --exclude='.env.example' --exclude='ci.yml' . || true)
          if [ -n "$FOUND" ]; then
            echo "::error::Potential hardcoded credentials found!"
            echo "$FOUND"
            exit 1
          fi
          echo "✓ No hardcoded credentials detected."

  # ── 前端检查 ────────────────────────────────────────
  frontend:
    name: Frontend Lint & Build
    runs-on: ubuntu-latest
    needs: secret-scan
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: TypeScript check
        run: npx tsc --noEmit

      - name: Build frontend
        run: npm run build

  # ── 后端检查 ────────────────────────────────────────
  backend:
    name: Rust Check & Clippy
    runs-on: ubuntu-latest
    needs: secret-scan
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libssl-dev \
            libsoup-3.0-dev \
            libjavascriptcoregtk-4.1-dev

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: Cargo check
        run: cargo check
        working-directory: src-tauri

      - name: Cargo clippy
        run: cargo clippy -- -D warnings
        working-directory: src-tauri

  # ── Tauri 构建（仅 main 分支） ─────────────────────
  build:
    name: Build Tauri App
    runs-on: ubuntu-latest
    needs: [frontend, backend]
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libssl-dev \
            libsoup-3.0-dev \
            libjavascriptcoregtk-4.1-dev

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: Install frontend dependencies
        run: npm ci

      - name: Build Tauri
        run: npx tauri build

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: qtunnel-linux
          path: |
            src-tauri/target/release/bundle/deb/*.deb
            src-tauri/target/release/bundle/appimage/*.AppImage
